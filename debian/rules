#!/usr/bin/make -f

export DH_VERBOSE = 1
export GOCACHE = $(CURDIR)/.gocache
export GOFLAGS = -mod=vendor -trimpath
export CGO_ENABLED = 0

# Map Debian architecture to Go architecture
DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
ifeq ($(DEB_HOST_ARCH),amd64)
    export GOARCH = amd64
else ifeq ($(DEB_HOST_ARCH),arm64)
    export GOARCH = arm64
else ifeq ($(DEB_HOST_ARCH),armhf)
    export GOARCH = arm
    export GOARM = 7
endif

%:
	dh $@

override_dh_auto_clean:
	rm -rf $(CURDIR)/.gocache
	rm -rf $(CURDIR)/build
	dh_auto_clean

override_dh_auto_build:
	mkdir -p build
	go build -ldflags="-s -w -X main.version=$(shell dpkg-parsechangelog -S Version | sed 's/-[^-]*$$//')" \
		-o build/debswarm ./cmd/debswarm

override_dh_auto_test:
	# Skip tests for now - requires network
	@echo "Skipping tests (requires network access)"

override_dh_auto_install:
	# Binary
	install -D -m 0755 build/debswarm \
		$(CURDIR)/debian/debswarm/usr/bin/debswarm

	# APT configuration
	install -D -m 0644 packaging/90debswarm.conf \
		$(CURDIR)/debian/debswarm/etc/apt/apt.conf.d/90debswarm.conf

	# System configuration (paths for systemd service)
	install -D -m 0644 packaging/config.system.toml \
		$(CURDIR)/debian/debswarm/etc/debswarm/config.toml

	# Documentation
	install -D -m 0644 README.md \
		$(CURDIR)/debian/debswarm/usr/share/doc/debswarm/README.md

override_dh_installsystemd:
	dh_installsystemd --name=debswarm

override_dh_dwz:
	# Skip dwz - Go binaries don't work well with it
	@echo "Skipping dwz for Go binary"

override_dh_strip:
	# Don't strip Go binaries - they're already stripped with -s -w
	@echo "Skipping strip for Go binary"

override_dh_makeshlibs:
	# Skip - Go binaries are statically linked, no shared libs to process
	@echo "Skipping makeshlibs for Go binary"

override_dh_shlibdeps:
	# Skip - Go binaries are statically linked, no shared lib deps
	@echo "Skipping shlibdeps for Go binary"
