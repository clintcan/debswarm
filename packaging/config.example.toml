# debswarm configuration example
# Copy to /etc/debswarm/config.toml or ~/.config/debswarm/config.toml
#
# For complete documentation of all options, see:
# https://github.com/debswarm/debswarm/blob/main/docs/configuration.md

#─────────────────────────────────────────────────────────────────────────────
# [network] - P2P and proxy settings
#─────────────────────────────────────────────────────────────────────────────
[network]
# P2P listen port (UDP for QUIC, TCP fallback)
# Make sure this port is accessible through your firewall for incoming connections
listen_port = 4001

# HTTP proxy port for APT
# APT connects to http://127.0.0.1:<port> via /etc/apt/apt.conf.d/90debswarm.conf
proxy_port = 9977

# Maximum concurrent P2P connections
# Prevents resource exhaustion; libp2p connection manager enforces this limit
max_connections = 100

# Connectivity detection mode (v1.8+)
# Controls how debswarm handles network connectivity:
#   "auto" = detect automatically (default) - checks mirror reachability
#   "lan_only" = only use mDNS peers, never try DHT or mirrors
#   "online_only" = fail if internet is unavailable (no LAN-only fallback)
connectivity_mode = "auto"

# How often to check connectivity (when mode is "auto")
# Go duration format: "30s", "1m", "5m"
connectivity_check_interval = "30s"

# URL to check for connectivity (typically a Debian/Ubuntu mirror)
# Used for HEAD requests to verify internet access
# connectivity_check_url = "https://deb.debian.org"

# Bootstrap peers for DHT initialization
# These are libp2p public bootstrap nodes; add your own for private networks
bootstrap_peers = [
  "/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN",
  "/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa",
  "/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb",
  "/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt",
]

#─────────────────────────────────────────────────────────────────────────────
# [cache] - Package cache settings
#─────────────────────────────────────────────────────────────────────────────
[cache]
# Cache directory for packages and SQLite database
# Use absolute path or ~ for home directory
# Note: CACHE_DIRECTORY env var (set by systemd) overrides this
path = "~/.cache/debswarm"

# Maximum cache size
# Supports: KB, MB, GB, TB suffixes (e.g., "10GB", "500MB")
# LRU eviction removes old packages when limit is reached
max_size = "10GB"

# Minimum free disk space to maintain
# Cache writes fail if this limit would be violated
min_free_space = "1GB"

#─────────────────────────────────────────────────────────────────────────────
# [transfer] - Upload/download settings
#─────────────────────────────────────────────────────────────────────────────
[transfer]
# Maximum upload bandwidth
# Supports: KB/s, MB/s, GB/s (e.g., "10MB/s", "500KB/s")
# Use "0" or "unlimited" for no limit
max_upload_rate = "0"

# Maximum download bandwidth
max_download_rate = "0"

# Per-peer rate limiting (default: "auto")
# Prevents any single peer from monopolizing bandwidth
#   "auto" = global_limit / expected_peers
#   "0" = disabled (only global limits apply)
#   Specific rate: "5MB/s"
per_peer_upload_rate = "auto"
per_peer_download_rate = "auto"

# Expected number of peers for auto-calculation
# Used when per_peer_*_rate is set to "auto"
expected_peers = 10

# Adaptive rate limiting (enabled by default when per-peer limiting is active)
# Automatically adjusts per-peer rates based on peer performance:
#   - High-performing peers get up to 1.5x the base rate
#   - Poorly-performing peers get reduced rates (down to min_rate)
#   - Congestion detection reduces rates when latency exceeds 500ms
# adaptive_rate_limiting = true

# Minimum rate floor for adaptive reduction
# Ensures no peer gets throttled below this threshold
adaptive_min_rate = "100KB/s"

# Maximum boost factor for high-performing peers
# 1.5 = up to 50% boost above base rate
adaptive_max_boost = 1.5

# Maximum concurrent uploads to other peers
# Limits how many peers can download from you simultaneously
max_concurrent_uploads = 20

# Maximum concurrent chunk downloads from peers
# Higher values may improve large file download speed
max_concurrent_peer_downloads = 10

# Automatic retry for failed downloads
# Set to 0 to disable automatic retry
retry_max_attempts = 3

# How often to check for failed downloads to retry
# Go duration format: "5m" (5 minutes), "1h" (1 hour), "30s" (30 seconds)
retry_interval = "5m"

# Don't retry downloads older than this
# Prevents retrying stale failures indefinitely
retry_max_age = "1h"

#─────────────────────────────────────────────────────────────────────────────
# [dht] - Distributed Hash Table settings
#─────────────────────────────────────────────────────────────────────────────
[dht]
# How long provider records (package announcements) remain in the DHT
# Shorter = faster propagation of removed packages
# Longer = less DHT traffic
provider_ttl = "24h"

# How often to re-announce cached packages to the DHT
# Should be less than provider_ttl to ensure continuous availability
announce_interval = "12h"

#─────────────────────────────────────────────────────────────────────────────
# [privacy] - Privacy and access control
#─────────────────────────────────────────────────────────────────────────────
[privacy]
# Enable mDNS for local network peer discovery
# Set to false if you don't want to be discoverable on LAN
enable_mdns = true

# Announce cached packages to the network
# Set to false to only download, never upload (leech mode)
announce_packages = true

# Private swarm settings
# Use 'debswarm psk generate' to create a PSK file
# All nodes in the private swarm must use the same PSK
psk_path = ""

# Inline PSK in hex format (mutually exclusive with psk_path)
# NOT RECOMMENDED - use psk_path instead for better security
# psk = ""

# List of allowed peer IDs (empty = allow all)
# Use to restrict connections to specific known peers
# Get peer IDs with 'debswarm identity show' on each node
peer_allowlist = []
# Example:
# peer_allowlist = [
#   "12D3KooWAbCdEfGhIjKlMnOpQrStUvWxYz...",
#   "12D3KooWBcDeFgHiJkLmNoPqRsTuVwXyZa...",
# ]

#─────────────────────────────────────────────────────────────────────────────
# [metrics] - Monitoring and dashboard
#─────────────────────────────────────────────────────────────────────────────
[metrics]
# Metrics/dashboard server port
# Set to 0 to disable metrics server entirely
port = 9978

# Metrics server bind address
# SECURITY WARNING: Changing from 127.0.0.1 exposes operational data:
#   - Cache statistics and hit rates
#   - Connected peer counts and IDs
#   - Download/upload statistics
#   - Runtime profiling data (pprof)
# If exposing externally, use a reverse proxy with authentication
bind = "127.0.0.1"

#─────────────────────────────────────────────────────────────────────────────
# [logging] - Log output settings
#─────────────────────────────────────────────────────────────────────────────
[logging]
# Log level: debug, info, warn, error
# Use "debug" for troubleshooting (very verbose)
level = "info"

# Log file path
# Empty = log to stderr (recommended for systemd services)
# When running as systemd service, use journalctl to view logs
file = ""

# Example: log to file (for non-systemd deployments)
# file = "/var/log/debswarm/debswarm.log"

#─────────────────────────────────────────────────────────────────────────────
# [logging.audit] - Structured audit logging (v1.8+)
#─────────────────────────────────────────────────────────────────────────────
[logging.audit]
# Enable structured audit logging
# Logs download/upload events, cache hits, and verification failures
# Output is JSON Lines format for easy parsing by log analysis tools
enabled = false

# Path for JSON audit log file
# The directory will be created if it doesn't exist
path = "/var/log/debswarm/audit.json"

# Max file size before rotation (MB)
# Old logs are renamed with .1, .2, etc. suffixes
max_size_mb = 100

# Number of rotated files to keep
# Oldest files are deleted when this limit is exceeded
max_backups = 5
